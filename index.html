<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clyver:Invoice - Clyvernaut Invoice Suite</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --igv-color: #4361ee;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --danger-color: #ef476f;
            --anomaly-color: #ff6b6b;
            --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --card-bg: #f8f9fa;
            --sidebar-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.12);
            --bg-light: #f5f7fb;
            --bg-dark: #121826;
            --card-dark: #1e293b;
            --text-light: #f1f5f9;
            --text-light-secondary: #94a3b8;
        }
        .dark-mode {
            --bg-light: var(--bg-dark);
            --card-bg: var(--card-dark);
            --sidebar-bg: var(--card-dark);
            --text-primary: var(--text-light);
            --text-secondary: var(--text-light-secondary);
            --border-color: #334155;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 6px 16px rgba(0,0,0,0.3);
            --shadow-lg: 0 12px 30px rgba(0,0,0,0.4);
            background-color: var(--bg-dark) !important;
            color: var(--text-light) !important;
        }
        * {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
        }
        .navbar {
            box-shadow: var(--shadow-md);
            padding: 1rem 0;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .nav-btn {
            border-radius: 12px;
            padding: 0.45rem 1rem;
            font-weight: 500;
            transition: all 0.25s ease;
            border: 2px solid transparent;
            background: transparent;
            color: var(--text-primary);
        }
        .dark-mode .nav-btn {
            color: var(--text-light);
        }
        .nav-btn:hover, .nav-btn.active {
            background: var(--sidebar-bg);
            color: var(--igv-color);
            border-color: var(--igv-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .dark-mode .nav-btn:hover, .dark-mode .nav-btn.active {
            background: var(--card-dark);
        }
        .section-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            position: relative;
            padding-bottom: 0.5rem;
        }
        .dark-mode .section-title {
            color: var(--text-light);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--igv-color);
            border-radius: 3px;
        }
        .card-shadow {
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: none;
            background: var(--card-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-primary);
        }
        .dark-mode .card-shadow {
            background: var(--card-dark);
            color: var(--text-light);
        }
        .card-shadow:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .product-alert {
            border-left: 4px solid var(--warning-color);
            background-color: #fffbeb;
        }
        .dark-mode .product-alert {
            background-color: #2a1f0f;
        }
        .anomaly-alert {
            border-left: 4px solid var(--anomaly-color);
            background-color: #ffecec;
        }
        .dark-mode .anomaly-alert {
            background-color: #3a1a1a;
        }
        .receipt-preview {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .dark-mode .receipt-preview {
            background: var(--card-dark);
            color: var(--text-light);
        }
        .logo-preview {
            max-height: 80px;
            max-width: 200px;
            object-fit: contain;
            margin-bottom: 16px;
        }
        .hidden-print {
            @media print {
                display: none !important;
            }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-preview, .receipt-preview * {
                visibility: visible;
            }
            .receipt-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
                border: none;
                background: white !important;
                color: black !important;
            }
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: var(--text-primary);
        }
        .dark-mode .form-label {
            color: var(--text-light);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .dark-mode .form-control, .dark-mode .form-select {
            background: var(--card-dark);
            color: var(--text-light);
            border-color: #334155;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--igv-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.25s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn-success {
            background: var(--success-color);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            border-radius: 12px;
            color: white;
        }
        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 12px;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            color: white;
        }
        .dark-mode .btn-secondary {
            background: #475569;
        }
        .btn-danger {
            background: var(--danger-color);
            border: none;
            border-radius: 10px;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            color: white;
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.8125rem;
        }
        .table {
            border-radius: 12px;
            overflow: hidden;
            color: var(--text-primary);
        }
        .dark-mode .table {
            color: var(--text-light);
        }
        .table thead th {
            background: #f1f3f9;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid var(--border-color);
        }
        .dark-mode .table thead th {
            background: #1e293b;
            color: #cbd5e1;
        }
        .table tbody tr {
            transition: background-color 0.2s;
        }
        .dark-mode .table tbody tr {
            background: var(--card-dark);
        }
        .table tbody tr:hover {
            background-color: #f8f9ff;
        }
        .dark-mode .table tbody tr:hover {
            background-color: #334155;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
        @media (max-width: 768px) {
            .navbar-nav {
                flex-direction: column !important;
                gap: 0.5rem;
            }
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
            .receipt-preview {
                padding: 15px;
            }
            .section-title::after {
                width: 30px;
            }
            .cashier-mode .btn-lg {
                padding: 1rem;
                font-size: 1.2rem;
            }
        }
        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dark-mode .theme-toggle {
            background: var(--card-dark);
            border-color: #334155;
        }
        .theme-toggle:hover {
            transform: rotate(20deg);
        }
        .thermal-print {
            font-family: 'Courier New', monospace;
            background: white;
            color: black;
            padding: 10px;
            white-space: pre-wrap;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }
        .help-shortcut {
            background: #eef2ff;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .dark-mode .help-shortcut {
            background: #1e293b;
        }
        .report-card {
            border-left: 4px solid var(--igv-color);
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .report-card.danger {
            border-left-color: var(--danger-color);
        }
        .report-card.success {
            border-left-color: var(--success-color);
        }
        .report-card.anomaly {
            border-left-color: var(--anomaly-color);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .trend-indicator {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .trend-up {
            background: rgba(6, 214, 160, 0.2);
            color: var(--success-color);
        }
        .trend-down {
            background: rgba(239, 71, 111, 0.2);
            color: var(--danger-color);
        }
        .product-ranking {
            max-height: 300px;
            overflow-y: auto;
        }
        .pdf-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }
        .pdf-success {
            color: var(--success-color);
        }
        .pdf-pending {
            color: var(--warning-color);
        }
        .anomaly-badge {
            background: rgba(255, 107, 107, 0.2);
            color: var(--anomaly-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand" href="#">Clyver:Invoice</a>
            <div class="d-flex align-items-center gap-3">
                <button class="theme-toggle" id="themeToggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                    </svg>
                </button>
                <button class="nav-btn" onclick="showHelpModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.664.246-.274 0-.524-.176-.664-.416l-.088-.416c.178-.274.453-.38 1.028-.38.194 0 .484.07.664.246L8.93 9.32c.36.792.1 1.319-.56 1.319-.301 0-.62-.158-.808-.469l-.738-3.468z"/>
                    </svg>
                </button>
                <div class="navbar-nav ms-auto">
                    <button class="nav-btn" onclick="showSection('productos')">Productos</button>
                    <button class="nav-btn" onclick="showSection('facturacion')">Facturación</button>
                    <button class="nav-btn" onclick="showSection('reportes')">Reportes</button>
                    <button class="nav-btn" onclick="showSection('configuracion')">Configuración</button>
                    <button class="nav-btn" onclick="showComprobantesGuardados()">Comprobantes</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <!-- Productos Section -->
        <div id="productos-section" class="section fade-in">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <h2 class="section-title mb-3 mb-md-0">Gestión Avanzada de Inventario</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary d-flex align-items-center gap-2" onclick="toggleProductForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Nuevo Producto
                    </button>
                    <button class="btn btn-secondary d-flex align-items-center gap-2" onclick="showMovimientosModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8a8 8 0 1 1-16 0A8 8 0 0 1 16 8zM8 2a6 6 0 1 0 0 12A6 6 0 0 0 8 2zm1 8.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        Movimientos
                    </button>
                </div>
            </div>
            <!-- Product Form -->
            <div id="product-form" class="card card-shadow p-4 mb-4 d-none">
                <h5 id="product-form-title" class="fw-bold mb-4">Registrar Nuevo Producto</h5>
                <form id="productForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Código Interno <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="codigo" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Descripción</label>
                            <input type="text" class="form-control" id="descripcion">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Precio Unitario <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">S/</span>
                                <input type="number" class="form-control" id="precio" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" onchange="toggleStockField()">
                                <option value="producto">Producto</option>
                                <option value="servicio">Servicio</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="unidad-field">
                            <label class="form-label">Unidad</label>
                            <select class="form-select" id="unidad">
                                <option value="UND">UND</option>
                                <option value="KG">KG</option>
                                <option value="LT">LT</option>
                                <option value="SERV">SERV</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="stock-field">
                            <label class="form-label">Stock Inicial</label>
                            <input type="number" class="form-control" id="stock" min="0" value="0">
                        </div>
                        <div class="col-md-3" id="stock-min-field">
                            <label class="form-label">Stock Mínimo</label>
                            <input type="number" class="form-control" id="stockMin" min="0" value="0" placeholder="Alerta si stock ≤ X">
                        </div>
                    </div>
                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" class="btn btn-success">Guardar Producto</button>
                        <button type="button" class="btn btn-secondary" onclick="toggleProductForm()">Cancelar</button>
                    </div>
                </form>
            </div>
            <!-- Product Search -->
            <div class="mb-4">
                <div class="input-group">
                    <span class="input-group-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </span>
                    <input type="text" class="form-control" id="productSearch" placeholder="Buscar por código o nombre..." oninput="filterProducts()">
                </div>
            </div>
            <!-- Products Table -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Unidad</th>
                            <th>Stock</th>
                            <th>Tipo</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Facturación Section -->
        <div id="facturacion-section" class="section d-none fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="section-title">Emisión de Comprobantes</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="cashierMode" onchange="toggleCashierMode()">
                    <label class="form-check-label" for="cashierMode">Modo Cajero</label>
                </div>
            </div>
            <div id="facturacionContent" class="row g-4">
                <div class="col-md-6">
                    <div class="card card-shadow p-4">
                        <h5 class="fw-bold mb-4">Datos del Cliente</h5>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Comprobante</label>
                            <select class="form-select" id="tipoComprobante" onchange="toggleClienteFields()">
                                <option value="boleta">Boleta</option>
                                <option value="factura">Factura</option>
                            </select>
                        </div>
                        <div id="clienteFields">
                            <div class="mb-3">
                                <label class="form-label">Razón Social <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="razonSocial" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">RUC (11 dígitos) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ruc" maxlength="11" oninput="validateRuc(this)">
                                <div id="rucError" class="text-danger mt-1" style="font-size: 0.875em;"></div>
                            </div>
                        </div>
                        <div id="additionalFields">
                            <!-- Added fields for both boletas and facturas -->
                            <div class="mb-3">
                                <label class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="nombreCliente">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">DNI (8 dígitos)</label>
                                <input type="text" class="form-control" id="dni" maxlength="8" oninput="validateDni(this)">
                                <div id="dniError" class="text-danger mt-1" style="font-size: 0.875em;"></div>
                            </div>
                            <div id="telefonoField" class="mb-3 d-none">
                                <label class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Punto de Venta</label>
                            <select class="form-select" id="puntoVenta">
                                <option value="CAJA 1">CAJA 1</option>
                                <option value="CAJA 2">CAJA 2</option>
                                <option value="TIENDA ONLINE">TIENDA ONLINE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Moneda</label>
                            <select class="form-select" id="moneda" onchange="toggleTipoCambio()">
                                <option value="PEN">Soles (PEN)</option>
                                <option value="USD">Dólares (USD)</option>
                            </select>
                        </div>
                        <div class="mb-3" id="tipoCambioField" style="display:none;">
                            <label class="form-label">Tipo de Cambio (PEN/USD)</label>
                            <input type="number" class="form-control" id="tipoCambio" step="0.001" value="3.80">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Precios incluyen IGV?</label>
                            <select class="form-select" id="igvIncluido">
                                <option value="si">Sí</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-shadow p-4">
                        <h5 class="fw-bold mb-4">Items del Comprobante</h5>
                        <div class="mb-3">
                            <label class="form-label">Agregar Producto/Servicio</label>
                            <select class="form-select" id="productSelect" onchange="addProductToInvoice()">
                                <option value="">Seleccionar producto/servicio</option>
                            </select>
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cant.</th>
                                        <th>P.U.</th>
                                        <th>Total</th>
                                        <th class="text-end">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceItems">
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="d-grid mt-4">
                            <button class="btn btn-primary d-flex align-items-center justify-content-center gap-2" onclick="generateInvoice()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M11 2H9v3H6v2h3v3h2V7h3V5h-3V2zm-4 8H5v2h2v2h2v-2h2v-2H9V8H7v2z"/>
                                </svg>
                                Generar Comprobante (F9)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Reportes Section -->
        <div id="reportes-section" class="section d-none fade-in">
            <h2 class="section-title">Reportes Técnicos Inteligentes</h2>
            <div class="row g-4 mb-4">
                <!-- Financial Metrics -->
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Ventas Brutas (con IGV)</h6>
                        <div class="metric-value text-success" id="ventasBrutas">S/ 0.00</div>
                        <div class="trend-indicator trend-up" id="ventasBrutasTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Ventas Netas (sin IGV)</h6>
                        <div class="metric-value" id="ventasNetas">S/ 0.00</div>
                        <div class="trend-indicator" id="ventasNetasTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Ticket Promedio</h6>
                        <div class="metric-value text-primary" id="ticketPromedio">S/ 0.00</div>
                        <div class="trend-indicator" id="ticketPromedioTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Proyección Diaria</h6>
                        <div class="metric-value" id="proyeccionDiaria">S/ 0.00</div>
                        <div class="trend-indicator" id="proyeccionTrend">Basado en tendencia actual</div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4 mb-4">
                <!-- Tax Metrics -->
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>IGV Recaudado</h6>
                        <div class="metric-value text-primary" id="igvRecaudado">S/ 0.00</div>
                        <div class="trend-indicator" id="igvTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Base Imponible</h6>
                        <div class="metric-value" id="baseImponible">S/ 0.00</div>
                        <div class="trend-indicator" id="baseTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>% Ventas Gravadas</h6>
                        <div class="metric-value text-success" id="porcentajeGravadas">0%</div>
                        <div class="trend-indicator" id="gravadasTrend">+0% vs ayer</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>IGV Acumulado</h6>
                        <div class="metric-value" id="igvAcumulado">S/ 0.00</div>
                        <div class="trend-indicator" id="igvAcumuladoTrend">Último mes</div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4 mb-4">
                <!-- Operational Metrics -->
                <div class="col-md-2">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Boletas</h6>
                        <div class="metric-value" id="totalBoletas">0</div>
                        <small>emitidas hoy</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Facturas</h6>
                        <div class="metric-value" id="totalFacturas">0</div>
                        <small>emitidas hoy</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Anulados</h6>
                        <div class="metric-value text-danger" id="totalAnulados">0</div>
                        <small>últimas 24h</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Último Comprobante</h6>
                        <div class="metric-value" id="ultimoComprobante">-</div>
                        <small id="ultimoComprobanteHora">-</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card report-card card-shadow p-3 text-center">
                        <h6>Productos Vendidos</h6>
                        <div class="metric-value" id="productosVendidos">0</div>
                        <small>últimas 24h</small>
                    </div>
                </div>
            </div>
            
            <!-- Anomaly Detection -->
            <div id="anomalyAlerts" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
                <div class="d-flex align-items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.981-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                    <strong>Detectadas anomalías:</strong> <span id="anomalyMessage"></span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            
            <!-- Product Ranking -->
            <div class="card card-shadow p-4 mb-4">
                <h5 class="fw-bold mb-3">Ranking de Productos - Últimos 7 Días</h5>
                <div class="product-ranking">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Posición</th>
                                <th>Producto</th>
                                <th>Unidades Vendidas</th>
                                <th>Ingresos (PEN)</th>
                            </tr>
                        </thead>
                        <tbody id="productRankingTable">
                            <!-- Product ranking will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Detailed Report Table -->
            <div class="card card-shadow p-4 mb-4">
                <h5 class="fw-bold mb-3">Resumen de Ventas - Últimos 7 Días</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Comprobantes</th>
                                <th>Ventas (PEN)</th>
                                <th>Ventas (USD)</th>
                                <th>IGV</th>
                                <th>PDF Generado</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Real data will be dynamically loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="d-flex gap-3">
                <button class="btn btn-primary" onclick="exportReportCSV()">Exportar a CSV</button>
                <button class="btn btn-secondary" onclick="showKardexReport()">Kardex</button>
            </div>
        </div>
        <!-- Configuración Section -->
        <div id="configuracion-section" class="section d-none fade-in">
            <h2 class="section-title">Configuración Empresarial</h2>
            <form id="configForm" class="row g-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Nombre de Empresa <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nombreEmpresa" placeholder="Ej: Empresa Ejemplo S.A.C." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">RUC <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="configRuc" placeholder="Ej: 20123456789" maxlength="11" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccion" placeholder="Ej: Av. Siempre Viva 123">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono" placeholder="Ej: +51 987 654 321">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="correo" placeholder="contacto@empresa.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sitio Web</label>
                        <input type="text" class="form-control" id="web" placeholder="www.empresa.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Logo</label>
                        <input type="file" class="form-control" id="logo" accept="image/*" onchange="previewLogo(event)">
                    </div>
                    <div class="mb-3 text-center">
                        <img id="logoPreview" class="logo-preview d-none rounded" alt="Logo preview">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Serie Boletas</label>
                        <input type="text" class="form-control" id="serieBoletas" value="B001">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Serie Facturas</label>
                        <input type="text" class="form-control" id="serieFacturas" value="F001">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">% IGV</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="igvPorcentaje" value="18" min="0" max="100" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 mt-4">
                    <h5 class="mb-3">Copia de Seguridad</h5>
                    <div class="d-flex gap-3">
                        <button type="button" class="btn btn-primary" onclick="backupData()">Respaldar Datos</button>
                        <button type="button" class="btn btn-secondary" onclick="restoreData()">Restaurar desde Copia</button>
                        <input type="file" id="restoreFile" accept=".json" class="d-none" onchange="handleRestoreFile(event)">
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="autoLock">
                        <label class="form-check-label" for="autoLock">Bloqueo automático tras 10 min inactividad</label>
                    </div>
                </div>
                <div class="col-12 mt-4">
                    <button type="submit" class="btn btn-success px-5">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for receipt preview -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-3 d-flex justify-content-between align-items-center">
                    <h5 class="modal-title fw-bold">Vista Previa del Comprobante</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showThermalPrint()">Térmica</button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div id="receiptPreview" class="receipt-preview">
                        <!-- Receipt content will be generated here -->
                    </div>
                    <div id="thermalPrintContent" class="thermal-print d-none p-3">
                        <!-- Thermal content -->
                    </div>
                </div>
                <div class="modal-footer hidden-print border-0 pt-3 pb-4">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                            <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                        </svg>
                        Imprimir
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportToPDF(true)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                            <path d="M4 2v1h8V2H4zm0 2v8h7V4H4zm1 1h2v1H5V5zm0 2h2v1H5V7zm0 2h2v1H5V9zm3 0h2v1H8V9zm0-2h2v1H8V7zm0-2h2v1H8V5z"/>
                        </svg>
                        Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for movements -->
    <div class="modal fade" id="movimientosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-3">
                    <h5 class="modal-title fw-bold">Movimientos de Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label">Producto</label>
                        <select class="form-select" id="movProduct">
                            <option>Seleccionar producto</option>
                        </select>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Movimiento</label>
                            <select class="form-select" id="movTipo">
                                <option value="entrada">Entrada (Compra)</option>
                                <option value="salida">Salida (Venta)</option>
                                <option value="ajuste">Ajuste</option>
                                <option value="perdida">Pérdida</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="movCantidad" min="1" value="1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Motivo</label>
                            <textarea class="form-control" id="movMotivo" rows="2" placeholder="Ej: Compra de proveedor XYZ"></textarea>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="saveMovement()">Registrar Movimiento</button>
                    <h5 class="mt-4 mb-3">Historial de Movimientos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Producto</th>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Motivo</th>
                                </tr>
                            </thead>
                            <tbody id="movimientosTable">
                                <!-- Movements will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Kardex -->
    <div class="modal fade" id="kardexModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-3">
                    <h5 class="modal-title fw-bold">Kardex</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Documento</th>
                                    <th>Entradas</th>
                                    <th>Salidas</th>
                                    <th>Saldo</th>
                                    <th>Costo Unit.</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="kardexTableBody">
                                <!-- Kardex data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for help -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-3">
                    <h5 class="modal-title fw-bold">Ayuda Rápida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <h6 class="mb-3">Atajos de Teclado</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><span class="help-shortcut">F9</span> Generar comprobante</li>
                        <li class="mb-2"><span class="help-shortcut">Enter</span> Agregar producto seleccionado</li>
                        <li class="mb-2"><span class="help-shortcut">Ctrl + P</span> Imprimir último comprobante</li>
                        <li class="mb-2"><span class="help-shortcut">Esc</span> Cerrar modales</li>
                    </ul>
                    <h6 class="mt-4 mb-2">Campos Importantes</h6>
                    <p class="text-muted small">• <strong>RUC:</strong> Solo 11 dígitos, debe empezar con 10 o 20.<br>
                    • <strong>Stock Mínimo:</strong> Recibirá alerta cuando el stock sea ≤ este valor.<br>
                    • <strong>Tipo de Cambio:</strong> Solo necesario si factura en USD.<br>
                    • <strong>DNI:</strong> Solo 8 dígitos numéricos para clientes.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for saved receipts -->
    <div class="modal fade" id="savedReceiptsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-3">
                    <h5 class="modal-title fw-bold">Comprobantes Guardados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Punto Venta</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="savedReceiptsBody">
                                <!-- Saved receipts will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        // Global variables
        let products = [];
        let config = {
            nombreEmpresa: '',
            ruc: '',
            direccion: '',
            telefono: '',
            correo: '',
            web: '',
            logo: '',
            serieBoletas: 'B001',
            serieFacturas: 'F001',
            igvPorcentaje: 18,
            autoLock: false,
            puntosVenta: ['CAJA 1', 'CAJA 2', 'TIENDA ONLINE']
        };
        let invoiceItems = [];
        let lastBoletaNumber = 0;
        let lastFacturaNumber = 0;
        let darkMode = false;
        let reportData = {
            today: new Date().toISOString().split('T')[0],
            daily: {},
            weekly: {},
            productRanking: [],
            anomalies: []
        };
        // DOM Elements
        const sections = {
            productos: document.getElementById('productos-section'),
            facturacion: document.getElementById('facturacion-section'),
            reportes: document.getElementById('reportes-section'),
            configuracion: document.getElementById('configuracion-section')
        };
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            await loadProducts();
            await scanExistingReceipts();
            await calculateReportData();
            updateReportUI();
            populateProductSelect();
            populateMovimientoProducts();
            showSection('productos');
            setupKeyboardShortcuts();
            applyTheme();
            // Set up form listeners
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('configForm').addEventListener('submit', saveConfig);
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });
        // Theme
        function toggleTheme() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            applyTheme();
        }
        function applyTheme() {
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 2a6 6 0 1 0 0 12A6 6 0 0 0 8 2zm0 11a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>';
            }
        }
        // Load theme preference
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'true') {
            darkMode = true;
        }
        // Section navigation
        function showSection(sectionName) {
            Object.keys(sections).forEach(key => {
                sections[key].classList.add('d-none');
                sections[key].classList.remove('fade-in');
            });
            sections[sectionName].classList.remove('d-none');
            setTimeout(() => sections[sectionName].classList.add('fade-in'), 10);
        }
        // Product management
        function toggleProductForm(editing = false, product = null) {
            const form = document.getElementById('product-form');
            const title = document.getElementById('product-form-title');
            const formFields = document.getElementById('productForm');
            if (!editing) {
                form.classList.toggle('d-none');
                title.textContent = 'Registrar Nuevo Producto';
                formFields.reset();
                document.getElementById('tipo').value = 'producto';
                document.getElementById('stock').value = '0';
                document.getElementById('stockMin').value = '0';
                toggleStockField();
            } else {
                form.classList.remove('d-none');
                title.textContent = 'Editar Producto';
                document.getElementById('codigo').value = product.codigo;
                document.getElementById('codigo').disabled = true;
                document.getElementById('nombre').value = product.nombre;
                document.getElementById('descripcion').value = product.descripcion;
                document.getElementById('precio').value = product.precio;
                document.getElementById('tipo').value = product.tipo;
                document.getElementById('unidad').value = product.unidad;
                document.getElementById('stockMin').value = product.stockMin || 0;
                if (product.tipo === 'producto') {
                    document.getElementById('stock').value = product.stock || 0;
                }
                toggleStockField();
            }
        }
        function toggleStockField() {
            const tipo = document.getElementById('tipo').value;
            const stockField = document.getElementById('stock-field');
            const stockMinField = document.getElementById('stock-min-field');
            const unidadField = document.getElementById('unidad-field');
            if (tipo === 'servicio') {
                stockField.classList.add('d-none');
                stockMinField.classList.add('d-none');
                document.getElementById('unidad').value = 'SERV';
                document.getElementById('unidad').disabled = true;
            } else {
                stockField.classList.remove('d-none');
                stockMinField.classList.remove('d-none');
                document.getElementById('unidad').disabled = false;
            }
        }
        async function saveProduct(e) {
            e.preventDefault();
            const codigo = document.getElementById('codigo').value;
            const nombre = document.getElementById('nombre').value;
            const descripcion = document.getElementById('descripcion').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const tipo = document.getElementById('tipo').value;
            const unidad = document.getElementById('unidad').value;
            const stock = tipo === 'producto' ? parseInt(document.getElementById('stock').value) : 0;
            const stockMin = tipo === 'producto' ? parseInt(document.getElementById('stockMin').value) : 0;
            // Validation
            if (!codigo || !nombre || !precio) {
                Swal.fire('Error', 'Todos los campos marcados con * son obligatorios', 'error');
                return;
            }
            const product = {
                codigo,
                nombre,
                descripcion,
                precio,
                tipo,
                unidad,
                stock: tipo === 'producto' ? stock : 0,
                stockMin: tipo === 'producto' ? stockMin : 0
            };
            if (document.getElementById('codigo').disabled) {
                // Editing
                const index = products.findIndex(p => p.codigo === codigo);
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                // New product
                if (products.some(p => p.codigo === codigo)) {
                    Swal.fire('Error', 'Ya existe un producto con este código', 'error');
                    return;
                }
                products.push(product);
            }
            await saveProducts();
            loadProducts();
            toggleProductForm();
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: 'Producto guardado correctamente',
                timer: 1500,
                showConfirmButton: false
            });
        }
        async function loadProducts() {
            try {
                const stored = await localforage.getItem('products');
                products = stored || [];
                renderProductsTable();
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
            }
        }
        async function saveProducts() {
            try {
                await localforage.setItem('products', products);
            } catch (error) {
                console.error('Error saving products:', error);
            }
        }
        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                if (product.tipo === 'producto' && product.stock <= (product.stockMin || 5)) {
                    row.classList.add('product-alert');
                }
                row.innerHTML = `
                    <td>${product.codigo}</td>
                    <td>${product.nombre}</td>
                    <td>${product.descripcion || ''}</td>
                    <td>S/ ${product.precio.toFixed(2)}</td>
                    <td>${product.unidad}</td>
                    <td>${product.tipo === 'producto' ? product.stock : 'N/A'}</td>
                    <td>${product.tipo === 'producto' ? 'Producto' : 'Servicio'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary me-1" onclick="toggleProductForm(true, ${JSON.stringify(product).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.codigo}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        async function deleteProduct(codigo) {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });
            if (result.isConfirmed) {
                products = products.filter(p => p.codigo !== codigo);
                await saveProducts();
                loadProducts();
                Swal.fire({
                    icon: 'success',
                    title: 'Eliminado',
                    text: 'Producto eliminado correctamente',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const filteredProducts = products.filter(product => 
                product.codigo.toLowerCase().includes(searchTerm) || 
                product.nombre.toLowerCase().includes(searchTerm)
            );
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                if (product.tipo === 'producto' && product.stock <= (product.stockMin || 5)) {
                    row.classList.add('product-alert');
                }
                row.innerHTML = `
                    <td>${product.codigo}</td>
                    <td>${product.nombre}</td>
                    <td>${product.descripcion || ''}</td>
                    <td>S/ ${product.precio.toFixed(2)}</td>
                    <td>${product.unidad}</td>
                    <td>${product.tipo === 'producto' ? product.stock : 'N/A'}</td>
                    <td>${product.tipo === 'producto' ? 'Producto' : 'Servicio'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-primary me-1" onclick="toggleProductForm(true, ${JSON.stringify(product).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.codigo}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function populateProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Seleccionar producto/servicio</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.codigo;
                option.textContent = `${product.codigo} - ${product.nombre} (S/ ${product.precio.toFixed(2)})`;
                select.appendChild(option);
            });
        }
        function populateMovimientoProducts() {
            const select = document.getElementById('movProduct');
            select.innerHTML = '<option>Seleccionar producto</option>';
            products.filter(p => p.tipo === 'producto').forEach(product => {
                const option = document.createElement('option');
                option.value = product.codigo;
                option.textContent = `${product.codigo} - ${product.nombre}`;
                select.appendChild(option);
            });
        }
        function addProductToInvoice() {
            const codigo = document.getElementById('productSelect').value;
            if (!codigo) return;
            const product = products.find(p => p.codigo === codigo);
            if (!product) return;
            if (product.tipo === 'producto' && product.stock <= 0) {
                Swal.fire('Stock insuficiente', 'No hay stock disponible para este producto', 'warning');
                return;
            }
            const quantity = 1;
            const item = {
                codigo: product.codigo,
                nombre: product.nombre,
                descripcion: product.descripcion,
                cantidad: quantity,
                precioUnitario: product.precio,
                unidad: product.unidad,
                tipo: product.tipo,
                stockDisponible: product.tipo === 'producto' ? product.stock : null
            };
            invoiceItems.push(item);
            renderInvoiceItems();
            document.getElementById('productSelect').selectedIndex = 0;
        }
        function renderInvoiceItems() {
            const tbody = document.getElementById('invoiceItems');
            tbody.innerHTML = '';
            invoiceItems.forEach((item, index) => {
                const total = item.cantidad * item.precioUnitario;
                const row = document.createElement('tr');
                let stockWarning = '';
                if (item.tipo === 'producto' && item.cantidad > (item.stockDisponible || 0)) {
                    stockWarning = '<span class="text-warning">(Stock insuficiente)</span>';
                }
                row.innerHTML = `
                    <td>${item.nombre} ${stockWarning}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" value="${item.cantidad}" 
                               min="1" onchange="updateItemQuantity(${index}, this.value)">
                    </td>
                    <td>S/ ${item.precioUnitario.toFixed(2)}</td>
                    <td>S/ ${total.toFixed(2)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-danger" onclick="removeItem(${index})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function updateItemQuantity(index, quantity) {
            quantity = parseInt(quantity);
            if (quantity < 1) quantity = 1;
            const item = invoiceItems[index];
            if (item.tipo === 'producto' && quantity > (item.stockDisponible || 0)) {
                const result = confirm('La cantidad excede el stock disponible. ¿Desea continuar?');
                if (!result) {
                    document.querySelectorAll('#invoiceItems input[type="number"]')[index].value = item.cantidad;
                    return;
                }
            }
            item.cantidad = quantity;
            renderInvoiceItems();
        }
        function removeItem(index) {
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
        }
        // Configuration management
        async function loadConfig() {
            try {
                const stored = await localforage.getItem('config');
                if (stored) {
                    config = { ...config, ...stored };
                    document.getElementById('nombreEmpresa').value = config.nombreEmpresa || '';
                    document.getElementById('configRuc').value = config.ruc || '';
                    document.getElementById('direccion').value = config.direccion || '';
                    document.getElementById('telefono').value = config.telefono || '';
                    document.getElementById('correo').value = config.correo || '';
                    document.getElementById('web').value = config.web || '';
                    if (config.logo) {
                        document.getElementById('logoPreview').src = config.logo;
                        document.getElementById('logoPreview').classList.remove('d-none');
                    }
                    document.getElementById('serieBoletas').value = config.serieBoletas || 'B001';
                    document.getElementById('serieFacturas').value = config.serieFacturas || 'F001';
                    document.getElementById('igvPorcentaje').value = config.igvPorcentaje || 18;
                    document.getElementById('autoLock').checked = config.autoLock || false;
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        async function saveConfig(e) {
            e.preventDefault();
            config.nombreEmpresa = document.getElementById('nombreEmpresa').value;
            config.ruc = document.getElementById('configRuc').value;
            config.direccion = document.getElementById('direccion').value;
            config.telefono = document.getElementById('telefono').value;
            config.correo = document.getElementById('correo').value;
            config.web = document.getElementById('web').value;
            config.serieBoletas = document.getElementById('serieBoletas').value;
            config.serieFacturas = document.getElementById('serieFacturas').value;
            config.igvPorcentaje = parseFloat(document.getElementById('igvPorcentaje').value);
            config.autoLock = document.getElementById('autoLock').checked;
            try {
                await localforage.setItem('config', config);
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Configuración guardada correctamente',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error saving config:', error);
                Swal.fire('Error', 'No se pudo guardar la configuración', 'error');
            }
        }
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoPreview').src = e.target.result;
                    document.getElementById('logoPreview').classList.remove('d-none');
                    config.logo = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        // Facturación - Enhanced with client details
        function toggleClienteFields() {
            const tipo = document.getElementById('tipoComprobante').value;
            const clienteFields = document.getElementById('clienteFields');
            const additionalFields = document.getElementById('additionalFields');
            const telefonoField = document.getElementById('telefonoField');
            
            // Reset additional fields
            document.getElementById('nombreCliente').value = '';
            document.getElementById('dni').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('dniError').textContent = '';
            
            if (tipo === 'boleta') {
                // For boletas, hide RUC fields but show additional client fields
                clienteFields.classList.add('d-none');
                document.getElementById('razonSocial').value = 'Consumidor Final';
                document.getElementById('ruc').value = '';
                
                // Show DNI and name fields
                additionalFields.classList.remove('d-none');
                telefonoField.classList.add('d-none');
            } else {
                // For facturas, show all fields
                clienteFields.classList.remove('d-none');
                document.getElementById('razonSocial').value = '';
                document.getElementById('ruc').value = '';
                
                // Show all additional fields including phone
                additionalFields.classList.remove('d-none');
                telefonoField.classList.remove('d-none');
            }
        }
        function toggleTipoCambio() {
            const moneda = document.getElementById('moneda').value;
            const field = document.getElementById('tipoCambioField');
            if (moneda === 'USD') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        }
        function validateRuc(input) {
            const ruc = input.value;
            const errorDiv = document.getElementById('rucError');
            if (ruc.length === 0) {
                errorDiv.textContent = '';
                return true;
            }
            if (ruc.length !== 11 || !/^\d+$/.test(ruc)) {
                errorDiv.textContent = 'El RUC debe tener 11 dígitos numéricos';
                return false;
            }
            const firstTwo = ruc.substring(0, 2);
            if (firstTwo !== '10' && firstTwo !== '20') {
                errorDiv.textContent = 'El RUC debe comenzar con 10 o 20';
                return false;
            }
            errorDiv.textContent = '';
            return true;
        }
        function validateDni(input) {
            const dni = input.value;
            const errorDiv = document.getElementById('dniError');
            if (dni.length === 0) {
                errorDiv.textContent = '';
                return true;
            }
            if (dni.length !== 8 || !/^\d+$/.test(dni)) {
                errorDiv.textContent = 'El DNI debe tener 8 dígitos numéricos';
                return false;
            }
            errorDiv.textContent = '';
            return true;
        }
        async function scanExistingReceipts() {
            try {
                const keys = await localforage.keys();
                const receiptKeys = keys.filter(key => key.startsWith('receipt_'));
                let maxBoleta = 0;
                let maxFactura = 0;
                for (const key of receiptKeys) {
                    const receipt = await localforage.getItem(key);
                    if (receipt.tipo === 'boleta') {
                        const number = parseInt(receipt.numero.split('-')[1]);
                        if (number > maxBoleta) maxBoleta = number;
                    } else if (receipt.tipo === 'factura') {
                        const number = parseInt(receipt.numero.split('-')[1]);
                        if (number > maxFactura) maxFactura = number;
                    }
                }
                lastBoletaNumber = maxBoleta;
                lastFacturaNumber = maxFactura;
            } catch (error) {
                console.error('Error scanning receipts:', error);
            }
        }
        function generateNextNumber(tipo) {
            if (tipo === 'boleta') {
                lastBoletaNumber++;
                return `${config.serieBoletas}-${String(lastBoletaNumber).padStart(8, '0')}`;
            } else {
                lastFacturaNumber++;
                return `${config.serieFacturas}-${String(lastFacturaNumber).padStart(8, '0')}`;
            }
        }
        async function generateInvoice() {
            const tipo = document.getElementById('tipoComprobante').value;
            const razonSocial = document.getElementById('razonSocial').value;
            const ruc = document.getElementById('ruc').value;
            const nombreCliente = document.getElementById('nombreCliente').value;
            const dni = document.getElementById('dni').value;
            const telefono = document.getElementById('telefono').value;
            const moneda = document.getElementById('moneda').value;
            const tipoCambio = moneda === 'USD' ? parseFloat(document.getElementById('tipoCambio').value) : 1;
            const igvIncluido = document.getElementById('igvIncluido').value === 'si';
            const puntoVenta = document.getElementById('puntoVenta').value;
            // Validation
            if (tipo === 'factura') {
                if (!razonSocial || !ruc || !validateRuc(document.getElementById('ruc'))) {
                    Swal.fire('Error', 'Complete todos los campos obligatorios para la factura', 'error');
                    return;
                }
                if (dni && !validateDni(document.getElementById('dni'))) {
                    Swal.fire('Error', 'DNI inválido para la factura', 'error');
                    return;
                }
            } else {
                // For boletas, validate DNI if provided
                if (dni && !validateDni(document.getElementById('dni'))) {
                    Swal.fire('Error', 'DNI inválido para la boleta', 'error');
                    return;
                }
            }
            if (invoiceItems.length === 0) {
                Swal.fire('Error', 'Agregue al menos un ítem al comprobante', 'error');
                return;
            }
            const insufficientStock = invoiceItems.some(item => 
                item.tipo === 'producto' && item.cantidad > (item.stockDisponible || 0)
            );
            if (insufficientStock) {
                const result = confirm('Hay ítems con stock insuficiente. ¿Desea continuar?');
                if (!result) return;
            }
            const numero = generateNextNumber(tipo);
            let subtotal = 0;
            let igv = 0;
            let total = 0;
            invoiceItems.forEach(item => {
                const itemTotal = item.cantidad * item.precioUnitario;
                if (igvIncluido) {
                    const itemSubtotal = itemTotal / (1 + config.igvPorcentaje / 100);
                    const itemIgv = itemTotal - itemSubtotal;
                    subtotal += itemSubtotal;
                    igv += itemIgv;
                    total += itemTotal;
                } else {
                    subtotal += itemTotal;
                    const itemIgv = itemTotal * (config.igvPorcentaje / 100);
                    igv += itemIgv;
                    total += itemTotal + itemIgv;
                }
            });
            const receipt = {
                id: `receipt_${Date.now()}`,
                tipo,
                numero,
                fecha: new Date().toISOString(),
                cliente: {
                    razonSocial: tipo === 'boleta' ? 'Consumidor Final' : razonSocial,
                    ruc: tipo === 'boleta' ? '' : ruc,
                    nombre: nombreCliente,
                    dni: dni,
                    telefono: tipo === 'factura' ? telefono : ''
                },
                moneda,
                tipoCambio: moneda === 'USD' ? tipoCambio : null,
                igvIncluido,
                puntoVenta,
                items: invoiceItems.map(item => ({
                    ...item,
                    total: item.cantidad * item.precioUnitario
                })),
                totales: {
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    igv: parseFloat(igv.toFixed(2)),
                    total: parseFloat(total.toFixed(2)),
                    totalUSD: moneda === 'USD' ? parseFloat(total.toFixed(2)) : parseFloat((total / tipoCambio).toFixed(2)),
                    totalPEN: moneda === 'PEN' ? parseFloat(total.toFixed(2)) : parseFloat((total * tipoCambio).toFixed(2))
                },
                configuracion: {
                    nombreEmpresa: config.nombreEmpresa,
                    ruc: config.ruc,
                    direccion: config.direccion,
                    telefono: config.telefono,
                    correo: config.correo,
                    web: config.web,
                    logo: config.logo,
                    igvPorcentaje: config.igvPorcentaje
                },
                pdfStatus: false
            };
            await localforage.setItem(receipt.id, receipt);
            updateStockAfterInvoice();
            await calculateReportData();
            updateReportUI();
            showReceiptPreview(receipt);
            invoiceItems = [];
            renderInvoiceItems();
            Swal.fire({
                icon: 'success',
                title: 'Comprobante Generado',
                text: `Número: ${numero}`,
                timer: 2000,
                showConfirmButton: false
            });
        }
        function updateStockAfterInvoice() {
            let stockUpdated = false;
            invoiceItems.forEach(item => {
                if (item.tipo === 'producto') {
                    const product = products.find(p => p.codigo === item.codigo);
                    if (product) {
                        product.stock -= item.cantidad;
                        stockUpdated = true;
                    }
                }
            });
            if (stockUpdated) {
                saveProducts();
                loadProducts();
                populateMovimientoProducts();
            }
        }
        function showReceiptPreview(receipt) {
            const preview = document.getElementById('receiptPreview');
            const monedaSymbol = receipt.moneda === 'PEN' ? 'S/' : '$';
            const igvLabel = receipt.igvIncluido ? 'IGV (incluido)' : 'IGV';
            let itemsHtml = '';
            receipt.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.codigo}</td>
                        <td>${item.nombre}</td>
                        <td class="text-end">${item.cantidad}</td>
                        <td class="text-end">${monedaSymbol} ${item.precioUnitario.toFixed(2)}</td>
                        <td class="text-end">${monedaSymbol} ${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            const logoHtml = receipt.configuracion.logo ? 
                `<img src="${receipt.configuracion.logo}" class="logo-preview mb-3" alt="Logo">` : '';
            // Client details
            let clientDetails = '';
            if (receipt.cliente.nombre) {
                clientDetails += `<p class="mb-1"><strong>Nombre:</strong> ${receipt.cliente.nombre}</p>`;
            }
            if (receipt.cliente.dni) {
                clientDetails += `<p class="mb-1"><strong>DNI:</strong> ${receipt.cliente.dni}</p>`;
            }
            if (receipt.cliente.telefono) {
                clientDetails += `<p class="mb-1"><strong>Teléfono:</strong> ${receipt.cliente.telefono}</p>`;
            }
            preview.innerHTML = `
                <div class="text-center mb-4">
                    ${logoHtml}
                    <h3 class="mb-2 fw-bold">${receipt.configuracion.nombreEmpresa}</h3>
                    <p class="mb-1 text-muted">RUC: ${receipt.configuracion.ruc}</p>
                    <p class="mb-1">${receipt.configuracion.direccion}</p>
                    <p class="mb-3">${receipt.configuracion.telefono} | ${receipt.configuracion.correo}</p>
                    <p class="mb-2"><strong>Punto de Venta:</strong> ${receipt.puntoVenta}</p>
                    <h2 class="mb-4 fw-bold text-primary">${receipt.tipo === 'boleta' ? 'BOLETA DE VENTA' : 'FACTURA'}</h2>
                </div>
                <div class="row mb-4">
                    <div class="col-6">
                        <p class="mb-1"><strong>Serie y Número:</strong> ${receipt.numero}</p>
                        <p class="mb-1"><strong>Fecha:</strong> ${new Date(receipt.fecha).toLocaleDateString('es-PE')}</p>
                    </div>
                    <div class="col-6 text-end">
                        <p class="mb-1"><strong>Cliente:</strong> ${receipt.cliente.razonSocial}</p>
                        ${receipt.cliente.ruc ? `<p class="mb-1"><strong>RUC:</strong> ${receipt.cliente.ruc}</p>` : ''}
                        ${clientDetails}
                    </div>
                </div>
                <table class="table table-bordered mb-4">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th class="text-end">Cant.</th>
                            <th class="text-end">P.U.</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <div class="row">
                    <div class="col-8"></div>
                    <div class="col-4">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-end">${monedaSymbol} ${receipt.totales.subtotal.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>${igvLabel} (${receipt.configuracion.igvPorcentaje}%):</strong></td>
                                <td class="text-end">${monedaSymbol} ${receipt.totales.igv.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td><strong>Total:</strong></td>
                                <td class="text-end"><strong>${monedaSymbol} ${receipt.totales.total.toFixed(2)}</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="text-center mt-4 pt-3 border-top">
                    <p class="mb-1">¡Gracias por su preferencia!</p>
                    ${receipt.configuracion.web ? `<p class="mb-0">${receipt.configuracion.web}</p>` : ''}
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            modal.show();
        }
        function showThermalPrint() {
            const receipt = document.getElementById('receiptPreview').innerHTML;
            const thermal = document.getElementById('thermalPrintContent');
            thermal.textContent = `
${config.nombreEmpresa}
RUC: ${config.ruc}
${config.direccion}
${config.telefono} | ${config.correo}
PUNTO DE VENTA: ${document.getElementById('puntoVenta').value}
${document.getElementById('tipoComprobante').value === 'boleta' ? 'BOLETA DE VENTA' : 'FACTURA'}
Serie y Número: ${document.querySelector('#receiptPreview .row .col-6 p').textContent.split(': ')[1]}
Fecha: ${new Date().toLocaleDateString('es-PE')}
Cliente: ${document.getElementById('tipoComprobante').value === 'boleta' ? 'Consumidor Final' : document.getElementById('razonSocial').value}
${document.getElementById('ruc').value ? `RUC: ${document.getElementById('ruc').value}` : ''}
${document.getElementById('nombreCliente').value ? `Nombre: ${document.getElementById('nombreCliente').value}` : ''}
${document.getElementById('dni').value ? `DNI: ${document.getElementById('dni').value}` : ''}
${document.getElementById('telefono').value ? `Teléfono: ${document.getElementById('telefono').value}` : ''}
------------------------------------------------
Cod.  Descripción           Cant  P.U.     Total
------------------------------------------------
${invoiceItems.map(item => 
    `${item.codigo.padEnd(6)}${item.nombre.substring(0,20).padEnd(20)}${item.cantidad.toString().padStart(4)}  ${item.precioUnitario.toFixed(2).padStart(7)}  ${ (item.cantidad * item.precioUnitario).toFixed(2).padStart(7)}`
).join('\n')}
------------------------------------------------
Subtotal:        S/ ${invoiceItems.reduce((a, b) => a + b.cantidad * b.precioUnitario, 0).toFixed(2)}
IGV (18%):       S/ ${(invoiceItems.reduce((a, b) => a + b.cantidad * b.precioUnitario, 0) * 0.18).toFixed(2)}
TOTAL:           S/ ${(invoiceItems.reduce((a, b) => a + b.cantidad * b.precioUnitario, 0) * 1.18).toFixed(2)}
------------------------------------------------
Gracias por su preferencia!
${config.web || ''}
            `.trim();
            document.getElementById('receiptPreview').classList.add('d-none');
            thermal.classList.remove('d-none');
        }
        function printReceipt() {
            window.print();
        }
        async function exportToPDF(markAsGenerated = false) {
            // Detectar si estamos en modo térmico
            const thermalContent = document.getElementById('thermalPrintContent');
            const receiptPreview = document.getElementById('receiptPreview');
            const isThermalMode = !thermalContent.classList.contains('d-none');
            
            const element = isThermalMode ? thermalContent : receiptPreview;
            if (!element || !element.offsetHeight) {
                Swal.fire('Error', 'No hay contenido visible para exportar', 'error');
                return;
            }

            // Extraer el número del comprobante (solo si no es térmico, porque en térmico no hay PDF status)
            let pdfName;
            if (isThermalMode) {
                // Nombre genérico para impresión térmica
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                pdfName = `Ticket_Termico_${timestamp}.pdf`;
            } else {
                // Nombre normal (corregido y seguro)
                let numero = 'SIN_NUMERO';
                const serieNumeroElement = document.querySelector('#receiptPreview .row .col-6 p');
                if (serieNumeroElement) {
                    const fullText = serieNumeroElement.textContent;
                    const match = fullText.match(/Serie y Número:\s*(.+)/);
                    if (match && match[1]) {
                        numero = match[1].trim().replace(/[^a-zA-Z0-9\-]/g, '_');
                    }
                }
                const isBoleta = document.querySelector('#receiptModal .modal-title').textContent.includes('Boleta');
                pdfName = isBoleta ? `Boleta_${numero}.pdf` : `Factura_${numero}.pdf`;
            }

            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff' // Fondo blanco obligatorio para térmico
                });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(pdfName);

                // Solo marcar como generado si NO es modo térmico
                if (markAsGenerated && !isThermalMode) {
                    const receiptId = document.querySelector('#receiptPreview .row .col-6 p').textContent.split(': ')[1];
                    const keys = await localforage.keys();
                    const receiptKey = keys.find(key => key.includes(receiptId));
                    if (receiptKey) {
                        const receipt = await localforage.getItem(receiptKey);
                        if (receipt) {
                            receipt.pdfStatus = true;
                            await localforage.setItem(receiptKey, receipt);
                            if (!document.getElementById('reportes-section').classList.contains('d-none')) {
                                await calculateReportData();
                                updateReportUI();
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Error generando PDF:', error);
                Swal.fire('Error', 'No se pudo generar el PDF. Intente de nuevo.', 'error');
            }
        }
        // Comprobantes guardados
        async function showComprobantesGuardados() {
            const tbody = document.getElementById('savedReceiptsBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando comprobantes...</td></tr>';
            try {
                const keys = await localforage.keys();
                const receiptKeys = keys.filter(key => key.startsWith('receipt_'));
                const receipts = [];
                for (const key of receiptKeys) {
                    const receipt = await localforage.getItem(key);
                    receipts.push(receipt);
                }
                receipts.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                tbody.innerHTML = '';
                if (receipts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay comprobantes guardados</td></tr>';
                } else {
                    receipts.forEach(receipt => {
                        const monedaSymbol = receipt.moneda === 'PEN' ? 'S/' : '$';
                        const pdfStatus = receipt.pdfStatus ? 
                            '<span class="pdf-status pdf-success"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06l2.75 2.75a.75.75 0 0 0 1.06 0l4.975-4.975a.75.75 0 0 0 .022-1.08z"/></svg> PDF Generado</span>' : 
                            '<span class="pdf-status pdf-pending">PDF Pendiente</span>';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><span class="badge bg-info">${receipt.tipo === 'boleta' ? 'Boleta' : 'Factura'}</span></td>
                            <td>${receipt.numero}</td>
                            <td>${receipt.cliente.razonSocial}</td>
                            <td>${receipt.puntoVenta}</td>
                            <td>${new Date(receipt.fecha).toLocaleDateString('es-PE')}</td>
                            <td class="fw-bold">${monedaSymbol} ${receipt.totales.total.toFixed(2)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-primary me-1" onclick="viewSavedReceipt('${receipt.id}')">Ver</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSavedReceipt('${receipt.id}', '${receipt.numero}')">Borrar</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                const modal = new bootstrap.Modal(document.getElementById('savedReceiptsModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading saved receipts:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error al cargar los comprobantes</td></tr>';
            }
        }
        async function viewSavedReceipt(receiptId) {
            try {
                const receipt = await localforage.getItem(receiptId);
                if (receipt) {
                    showReceiptPreview(receipt);
                    const savedModal = bootstrap.Modal.getInstance(document.getElementById('savedReceiptsModal'));
                    if (savedModal) savedModal.hide();
                }
            } catch (error) {
                console.error('Error loading receipt:', error);
                Swal.fire('Error', 'No se pudo cargar el comprobante', 'error');
            }
        }
        async function deleteSavedReceipt(receiptId, numero) {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                html: `Se eliminará el comprobante <strong>${numero}</strong>.<br>Se registrará en el log de auditoría.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, borrar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#d33'
            });
            if (result.isConfirmed) {
                try {
                    // Get the receipt to update report data
                    const receipt = await localforage.getItem(receiptId);
                    
                    // Log deletion
                    const logEntry = {
                        action: 'DELETE_RECEIPT',
                        receiptId,
                        numero,
                        timestamp: new Date().toISOString(),
                        user: 'usuario_local'
                    };
                    const logs = await localforage.getItem('auditLogs') || [];
                    logs.push(logEntry);
                    await localforage.setItem('auditLogs', logs);
                    await localforage.removeItem(receiptId);
                    
                    // Recalculate report data after deletion
                    await calculateReportData();
                    updateReportUI();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Eliminado',
                        text: `El comprobante ${numero} ha sido borrado.`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                    showComprobantesGuardados();
                } catch (error) {
                    console.error('Error al borrar el comprobante:', error);
                    Swal.fire('Error', 'No se pudo eliminar el comprobante.', 'error');
                }
            }
        }
        // Movimientos
        function showMovimientosModal() {
            populateMovimientoProducts();
            const modal = new bootstrap.Modal(document.getElementById('movimientosModal'));
            modal.show();
        }
        function saveMovement() {
            Swal.fire({
                icon: 'success',
                title: 'Movimiento Registrado',
                text: 'El movimiento de stock ha sido registrado correctamente.',
                timer: 1500,
                showConfirmButton: false
            });
        }
        // Enhanced Reporting System
        async function calculateReportData() {
            // Reset report data
            reportData = {
                today: new Date().toISOString().split('T')[0],
                daily: {},
                weekly: {},
                productRanking: [],
                anomalies: []
            };
            
            // Get all receipts
            const keys = await localforage.keys();
            const receiptKeys = keys.filter(key => key.startsWith('receipt_'));
            const receipts = [];
            for (const key of receiptKeys) {
                const receipt = await localforage.getItem(key);
                receipts.push(receipt);
            }
            
            // Group receipts by date
            const dailyData = {};
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            const sevenDaysAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
            
            // Initialize daily data for last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000).toISOString().split('T')[0];
                dailyData[date] = {
                    boletas: 0,
                    facturas: 0,
                    ventasBrutas: 0,
                    ventasNetas: 0,
                    igv: 0,
                    totalComprobantes: 0,
                    totalItems: 0,
                    pdfGenerated: 0
                };
            }
            
            // Process all receipts
            const productSales = {};
            let totalBoletas = 0;
            let totalFacturas = 0;
            let totalAnulados = 0; // In a real system, this would track cancellations
            let lastComprobante = null;
            let lastComprobanteTime = null;
            
            receipts.forEach(receipt => {
                const date = receipt.fecha.split('T')[0];
                if (date >= sevenDaysAgo) {
                    if (!dailyData[date]) {
                        dailyData[date] = {
                            boletas: 0,
                            facturas: 0,
                            ventasBrutas: 0,
                            ventasNetas: 0,
                            igv: 0,
                            totalComprobantes: 0,
                            totalItems: 0,
                            pdfGenerated: 0
                        };
                    }
                    
                    // Count comprobantes
                    if (receipt.tipo === 'boleta') {
                        dailyData[date].boletas++;
                        totalBoletas++;
                    } else {
                        dailyData[date].facturas++;
                        totalFacturas++;
                    }
                    dailyData[date].totalComprobantes++;
                    
                    // Sum financial data
                    dailyData[date].ventasBrutas += receipt.totales.total;
                    dailyData[date].ventasNetas += receipt.totales.subtotal;
                    dailyData[date].igv += receipt.totales.igv;
                    
                    // Count items
                    dailyData[date].totalItems += receipt.items.length;
                    
                    // Count PDF generated
                    if (receipt.pdfStatus) {
                        dailyData[date].pdfGenerated++;
                    }
                    
                    // Track last comprobante
                    if (!lastComprobanteTime || new Date(receipt.fecha) > new Date(lastComprobanteTime)) {
                        lastComprobante = receipt.numero;
                        lastComprobanteTime = receipt.fecha;
                    }
                    
                    // Track product sales
                    receipt.items.forEach(item => {
                        if (!productSales[item.codigo]) {
                            productSales[item.codigo] = {
                                nombre: item.nombre,
                                unidades: 0,
                                ingresos: 0
                            };
                        }
                        productSales[item.codigo].unidades += item.cantidad;
                        productSales[item.codigo].ingresos += item.total;
                    });
                }
            });
            
            // Calculate product ranking
            reportData.productRanking = Object.entries(productSales)
                .map(([codigo, data]) => ({ codigo, ...data }))
                .sort((a, b) => b.unidades - a.unidades)
                .slice(0, 10);
            
            // Calculate anomalies
            const todayData = dailyData[today] || { ventasBrutas: 0, totalComprobantes: 0, igv: 0 };
            const yesterdayData = dailyData[yesterday] || { ventasBrutas: 0, totalComprobantes: 0, igv: 0 };
            
            // Check for zero sales
            if (todayData.ventasBrutas === 0 && yesterdayData.ventasBrutas > 0) {
                reportData.anomalies.push("Ventas en cero hoy después de ventas ayer");
            }
            
            // Check for sharp drops
            const ventasDrop = yesterdayData.ventasBrutas > 0 ? 
                (yesterdayData.ventasBrutas - todayData.ventasBrutas) / yesterdayData.ventasBrutas * 100 : 0;
            if (ventasDrop > 50) {
                reportData.anomalies.push(`Caída brusca de ventas: -${ventasDrop.toFixed(1)}%`);
            }
            
            // Check for atypical IGV
            const expectedIgv = todayData.ventasBrutas * (config.igvPorcentaje / (100 + config.igvPorcentaje));
            const igvDifference = Math.abs(todayData.igv - expectedIgv);
            if (igvDifference > todayData.igv * 0.2) { // 20% tolerance
                reportData.anomalies.push("IGV atípico detectado");
            }
            
            // Calculate financial metrics
            const todayFinancial = {
                ventasBrutas: todayData.ventasBrutas,
                ventasNetas: todayData.ventasNetas,
                igvRecaudado: todayData.igv,
                ticketPromedio: todayData.totalComprobantes > 0 ? 
                    todayData.ventasBrutas / todayData.totalComprobantes : 0
            };
            
            // Calculate trends
            const ventasBrutasTrend = yesterdayData.ventasBrutas > 0 ? 
                (todayFinancial.ventasBrutas - yesterdayData.ventasBrutas) / yesterdayData.ventasBrutas * 100 : 0;
            const ventasNetasTrend = yesterdayData.ventasNetas > 0 ? 
                (todayFinancial.ventasNetas - yesterdayData.ventasNetas) / yesterdayData.ventasNetas * 100 : 0;
            const ticketPromedioTrend = yesterdayData.totalComprobantes > 0 ? 
                (todayFinancial.ticketPromedio - (yesterdayData.ventasBrutas / yesterdayData.totalComprobantes)) / 
                (yesterdayData.ventasBrutas / yesterdayData.totalComprobantes) * 100 : 0;
            
            // Calculate projections
            const last7Days = Object.values(dailyData)
                .filter(d => d.ventasBrutas > 0)
                .slice(-7);
            const avgDailySales = last7Days.reduce((sum, day) => sum + day.ventasBrutas, 0) / last7Days.length;
            const currentHour = new Date().getHours();
            const projectionFactor = currentHour > 0 ? 24 / currentHour : 1;
            const proyeccionDiaria = avgDailySales * projectionFactor;
            
            // Tax metrics
            const totalVentas = Object.values(dailyData).reduce((sum, day) => sum + day.ventasNetas, 0);
            const totalVentasGravadas = totalVentas; // Assuming all sales are gravadas
            const porcentajeGravadas = totalVentas > 0 ? 100 : 0;
            const igvAcumulado = Object.values(dailyData).reduce((sum, day) => sum + day.igv, 0);
            
            // Save to reportData
            reportData.daily = {
                today: todayFinancial,
                yesterday: {
                    ventasBrutas: yesterdayData.ventasBrutas,
                    ventasNetas: yesterdayData.ventasNetas,
                    igvRecaudado: yesterdayData.igv,
                    ticketPromedio: yesterdayData.totalComprobantes > 0 ? 
                        yesterdayData.ventasBrutas / yesterdayData.totalComprobantes : 0
                },
                trends: {
                    ventasBrutas: ventasBrutasTrend,
                    ventasNetas: ventasNetasTrend,
                    ticketPromedio: ticketPromedioTrend
                },
                projection: proyeccionDiaria,
                tax: {
                    totalVentas,
                    totalVentasGravadas,
                    porcentajeGravadas,
                    igvAcumulado
                },
                operational: {
                    totalBoletas,
                    totalFacturas,
                    totalAnulados,
                    lastComprobante,
                    lastComprobanteTime,
                    productosVendidos: Object.values(productSales).reduce((sum, p) => sum + p.unidades, 0)
                }
            };
            
            reportData.weekly = dailyData;
        }
        
        function updateReportUI() {
            const r = reportData.daily;
            
            // Financial metrics
            document.getElementById('ventasBrutas').textContent = `S/ ${r.today.ventasBrutas.toFixed(2)}`;
            document.getElementById('ventasNetas').textContent = `S/ ${r.today.ventasNetas.toFixed(2)}`;
            document.getElementById('ticketPromedio').textContent = `S/ ${r.today.ticketPromedio.toFixed(2)}`;
            document.getElementById('proyeccionDiaria').textContent = `S/ ${r.projection.toFixed(2)}`;
            
            // Trends
            const ventasBrutasTrend = r.trends.ventasBrutas;
            document.getElementById('ventasBrutasTrend').textContent = 
                `${ventasBrutasTrend >= 0 ? '+' : ''}${ventasBrutasTrend.toFixed(1)}% vs ayer`;
            document.getElementById('ventasBrutasTrend').className = 
                `trend-indicator ${ventasBrutasTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            const ventasNetasTrend = r.trends.ventasNetas;
            document.getElementById('ventasNetasTrend').textContent = 
                `${ventasNetasTrend >= 0 ? '+' : ''}${ventasNetasTrend.toFixed(1)}% vs ayer`;
            document.getElementById('ventasNetasTrend').className = 
                `trend-indicator ${ventasNetasTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            const ticketPromedioTrend = r.trends.ticketPromedio;
            document.getElementById('ticketPromedioTrend').textContent = 
                `${ticketPromedioTrend >= 0 ? '+' : ''}${ticketPromedioTrend.toFixed(1)}% vs ayer`;
            document.getElementById('ticketPromedioTrend').className = 
                `trend-indicator ${ticketPromedioTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            document.getElementById('proyeccionTrend').textContent = 'Basado en tendencia actual';
            
            // Tax metrics
            document.getElementById('igvRecaudado').textContent = `S/ ${r.today.igvRecaudado.toFixed(2)}`;
            document.getElementById('baseImponible').textContent = `S/ ${r.today.ventasNetas.toFixed(2)}`;
            document.getElementById('porcentajeGravadas').textContent = `${r.tax.porcentajeGravadas.toFixed(1)}%`;
            document.getElementById('igvAcumulado').textContent = `S/ ${r.tax.igvAcumulado.toFixed(2)}`;
            
            // Trends for tax metrics
            const igvTrend = r.trends.ventasBrutas; // Using same trend as sales
            document.getElementById('igvTrend').textContent = 
                `${igvTrend >= 0 ? '+' : ''}${igvTrend.toFixed(1)}% vs ayer`;
            document.getElementById('igvTrend').className = 
                `trend-indicator ${igvTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            document.getElementById('baseTrend').textContent = 
                `${ventasNetasTrend >= 0 ? '+' : ''}${ventasNetasTrend.toFixed(1)}% vs ayer`;
            document.getElementById('baseTrend').className = 
                `trend-indicator ${ventasNetasTrend >= 0 ? 'trend-up' : 'trend-down'}`;
            
            document.getElementById('gravadasTrend').textContent = 'Estable';
            document.getElementById('gravadasTrend').className = 'trend-indicator';
            
            document.getElementById('igvAcumuladoTrend').textContent = 'Último mes';
            
            // Operational metrics
            document.getElementById('totalBoletas').textContent = r.operational.totalBoletas;
            document.getElementById('totalFacturas').textContent = r.operational.totalFacturas;
            document.getElementById('totalAnulados').textContent = r.operational.totalAnulados;
            
            if (r.operational.lastComprobante) {
                document.getElementById('ultimoComprobante').textContent = r.operacional.lastComprobante;
                document.getElementById('ultimoComprobanteHora').textContent = 
                    new Date(r.operational.lastComprobanteTime).toLocaleTimeString('es-PE');
            } else {
                document.getElementById('ultimoComprobante').textContent = '-';
                document.getElementById('ultimoComprobanteHora').textContent = '-';
            }
            
            document.getElementById('productosVendidos').textContent = r.operational.productosVendidos;
            
            // Anomaly detection
            const anomalyAlert = document.getElementById('anomalyAlerts');
            if (reportData.anomalies.length > 0) {
                document.getElementById('anomalyMessage').textContent = reportData.anomalies.join(', ');
                anomalyAlert.classList.remove('d-none');
            } else {
                anomalyAlert.classList.add('d-none');
            }
            
            // Product ranking
            const rankingTable = document.getElementById('productRankingTable');
            rankingTable.innerHTML = '';
            if (reportData.productRanking.length > 0) {
                reportData.productRanking.forEach((product, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${product.nombre}</td>
                        <td>${product.unidades}</td>
                        <td>S/ ${product.ingresos.toFixed(2)}</td>
                    `;
                    rankingTable.appendChild(row);
                });
            } else {
                rankingTable.innerHTML = '<tr><td colspan="4" class="text-center">No hay datos de ventas</td></tr>';
            }
            
            // Detailed report table
            const reportTable = document.getElementById('reportTableBody');
            reportTable.innerHTML = '';
            Object.entries(reportData.weekly).reverse().forEach(([date, data]) => {
                const pdfStatus = data.pdfGenerated === data.totalComprobantes ? 
                    '<span class="badge bg-success">Completo</span>' : 
                    `<span class="badge bg-warning">${data.pdfGenerated}/${data.totalComprobantes}</span>`;
                const row = document.createElement('tr');
                if (data.ventasBrutas === 0) {
                    row.classList.add('anomaly-alert');
                }
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${data.totalComprobantes}</td>
                    <td>S/ ${data.ventasBrutas.toFixed(2)}</td>
                    <td>$ ${data.ventasBrutas / 3.80.toFixed(2)}</td>
                    <td>S/ ${data.igv.toFixed(2)}</td>
                    <td>${pdfStatus}</td>
                `;
                reportTable.appendChild(row);
            });
        }
        
        // Reportes functions
        function exportReportCSV() {
            const tbody = document.getElementById('reportTableBody');
            if (!tbody || tbody.children.length === 0) {
                Swal.fire('Información', 'No hay datos para exportar.', 'info');
                return;
            }

            let csvContent = "Fecha,Comprobantes,\"Ventas (PEN)\",\"Ventas (USD)\",\"IGV\",\"PDF Generado\"\n";
            for (let row of tbody.children) {
                let rowData = [];
                for (let cell of row.children) {
                    // Eliminar símbolos innecesarios y mantener el valor limpio
                    let text = cell.innerText
                        .replace(/^[S$]\s*/,'')        // quita "S/ " o "$ " al inicio
                        .replace(/\s+/g, ' ')          // normaliza espacios
                        .trim();
                    // Escapar comas y comillas para CSV válido
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    rowData.push(text);
                }
                csvContent += rowData.join(",") + "\n";
            }

            // Crear blob y descargar
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "reporte_ventas.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // liberar memoria

            Swal.fire({
                icon: 'success',
                title: 'Exportado',
                text: 'Reporte exportado como CSV.',
                timer: 1500,
                showConfirmButton: false
            });
        }
        function showKardexReport() {
            // Clear previous data
            document.getElementById('kardexTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Cargando kardex...</td></tr>';
            // In a real implementation, this would load based on selected product
            // For now, we leave it empty or show a message
            document.getElementById('kardexTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Seleccione un producto para ver su kardex</td></tr>';
            const modal = new bootstrap.Modal(document.getElementById('kardexModal'));
            modal.show();
        }
        // Backup and restore
        function backupData() {
            const data = {
                products: products,
                config: config,
                receipts: [],
                logs: []
            };
            // Get receipts
            localforage.keys().then(keys => {
                const receiptKeys = keys.filter(k => k.startsWith('receipt_'));
                Promise.all(receiptKeys.map(k => localforage.getItem(k))).then(receipts => {
                    data.receipts = receipts;
                    data.logs = []; // Could load logs too
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = 'facturacion_backup.json';
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    Swal.fire({
                        icon: 'success',
                        title: 'Respaldo Creado',
                        text: 'Archivo de respaldo descargado.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                });
            });
        }
        function restoreData() {
            document.getElementById('restoreFile').click();
        }
        function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const result = await Swal.fire({
                        title: 'Confirmar Restauración',
                        html: `Se restaurarán:<br>
                        - ${data.products.length} productos<br>
                        - Configuración empresarial<br>
                        - ${data.receipts.length} comprobantes<br>
                        <strong>Esta acción reemplazará todos los datos actuales.</strong>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, restaurar',
                        cancelButtonText: 'Cancelar'
                    });
                    if (result.isConfirmed) {
                        await localforage.setItem('products', data.products);
                        await localforage.setItem('config', data.config);
                        // Clear existing receipts
                        const keys = await localforage.keys();
                        for (const key of keys) {
                            if (key.startsWith('receipt_')) {
                                await localforage.removeItem(key);
                            }
                        }
                        // Save new receipts
                        for (const receipt of data.receipts) {
                            await localforage.setItem(receipt.id, receipt);
                        }
                        Swal.fire({
                            icon: 'success',
                            title: 'Restaurado',
                            text: 'Datos restaurados correctamente.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        // Recalculate reports after restore
                        await calculateReportData();
                        updateReportUI();
                        location.reload();
                    }
                } catch (error) {
                    Swal.fire('Error', 'Archivo de respaldo inválido.', 'error');
                }
            };
            reader.readAsText(file);
        }
        // Help
        function showHelpModal() {
            const modal = new bootstrap.Modal(document.getElementById('helpModal'));
            modal.show();
        }
        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F9' || (e.ctrlKey && e.key === 'g')) {
                    e.preventDefault();
                    if (document.getElementById('facturacion-section').classList.contains('d-none') === false) {
                        generateInvoice();
                    }
                }
                if (e.key === 'Enter' && document.activeElement.id === 'productSelect') {
                    e.preventDefault();
                    addProductToInvoice();
                }
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    // Print last receipt (mock)
                    Swal.fire('Atajo', 'Ctrl+P: Imprimir último comprobante', 'info');
                }
            });
        }
        // Cashier mode
        function toggleCashierMode() {
            const isCashier = document.getElementById('cashierMode').checked;
            const content = document.getElementById('facturacionContent');
            if (isCashier) {
                content.classList.add('cashier-mode');
                // Make buttons larger
                const buttons = content.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.classList.add('btn-lg');
                });
            } else {
                content.classList.remove('cashier-mode');
                const buttons = content.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.classList.remove('btn-lg');
                });
            }
        }
    </script>
    <!-- PANEL AVANZADO ALNDIN CON PESTAÑAS -->
    <div id="alndinFloatingBtn" class="alndin-trigger" title="Herramientas Alndin">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="M6.5 7a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1A.5.5 0 0 0 6.5 7zm4 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-.5-.5zM8 4a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1A.5.5 0 0 0 8 4z"/>
    </svg>
    </div>

    <div id="alndinPanel" class="alndin-panel d-none">
    <div class="alndin-panel-header d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold">Panel</h5>
        <button id="closeAlndinPanel" class="btn-close" aria-label="Cerrar"></button>
    </div>

    <!-- Pestañas -->
    <ul class="nav nav-tabs mb-3" id="alndinTabs" role="tablist">
        <li class="nav-item" role="presentation">
        <button class="nav-link active" id="calc-tab" data-bs-toggle="tab" data-bs-target="#calc-tab-pane" type="button" role="tab">Calculadora</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-tab-pane" type="button" role="tab">Notas</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="social-tab" data-bs-toggle="tab" data-bs-target="#social-tab-pane" type="button" role="tab">Redes</button>
        </li>
    </ul>

    <!-- Contenido de pestañas -->
    <div class="tab-content" id="alndinTabContent">
        <!-- Calculadora avanzada -->
        <div class="tab-pane fade show active" id="calc-tab-pane" role="tabpanel">
        <div class="position-relative">
            <textarea id="alndinCalcHistory" class="form-control mb-2" rows="3" readonly placeholder="Historial"></textarea>
            <input type="text" id="alndinCalcDisplay" class="form-control fs-4 fw-bold text-end mb-2" placeholder="0" readonly>
        </div>
        <div class="calc-grid mb-2">
            <!-- Fila 1: funciones -->
            <button class="calc-btn func" onclick="alndinCalcInput('Math.sqrt(')">√</button>
            <button class="calc-btn func" onclick="alndinCalcInput('Math.pow(', true)">^</button>
            <button class="calc-btn func" onclick="alndinCalcInput('(')">(</button>
            <button class="calc-btn func" onclick="alndinCalcInput(')')">)</button>
            <button class="calc-btn clear" onclick="alndinCalcClear()">C</button>
            <!-- Fila 2 -->
            <button class="calc-btn" onclick="alndinCalcInput('7')">7</button>
            <button class="calc-btn" onclick="alndinCalcInput('8')">8</button>
            <button class="calc-btn" onclick="alndinCalcInput('9')">9</button>
            <button class="calc-btn operator" onclick="alndinCalcInput('/')">/</button>
            <button class="calc-btn operator" onclick="alndinCalcInput('*')">×</button>
            <!-- Fila 3 -->
            <button class="calc-btn" onclick="alndinCalcInput('4')">4</button>
            <button class="calc-btn" onclick="alndinCalcInput('5')">5</button>
            <button class="calc-btn" onclick="alndinCalcInput('6')">6</button>
            <button class="calc-btn operator" onclick="alndinCalcInput('-')">−</button>
            <button class="calc-btn operator" onclick="alndinCalcInput('+')">+</button>
            <!-- Fila 4 -->
            <button class="calc-btn" onclick="alndinCalcInput('1')">1</button>
            <button class="calc-btn" onclick="alndinCalcInput('2')">2</button>
            <button class="calc-btn" onclick="alndinCalcInput('3')">3</button>
            <button class="calc-btn equal" onclick="alndinCalcEval()" rowspan="2">=</button>
            <!-- Fila 5 -->
            <button class="calc-btn" onclick="alndinCalcInput('0')">0</button>
            <button class="calc-btn" onclick="alndinCalcInput('.')">.</button>
            <button class="calc-btn" onclick="alndinCalcInput('00')">00</button>
        </div>
        <button class="btn btn-sm btn-danger w-100" onclick="alndinCalcClearAll()">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            </svg> Borrar historial
        </button>
        </div>

        <!-- Pestaña avanzada: Blog de notas tipo Word con gestor de notas guardadas -->
        <div class="tab-pane fade" id="notes-tab-pane" role="tabpanel">
        <!-- Toolbar principal -->
        <div class="btn-toolbar mb-2 border rounded-top p-2 alndin-notes-toolbar" style="background: var(--card-bg); border-color: var(--border-color);">
            <div class="btn-group me-1">
            <button type="button" class="btn btn-sm" title="Negrita" onclick="document.execCommand('bold', false, null)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M7.5 11H9a.5.5 0 0 1 .5.5v.5a.5.5 0 0 1-.5.5H7.5V13H6v-.5a.5.5 0 0 1 .5-.5h1v-1zm-3-6h4.5a.5.5 0 0 1 .5.5v.5a.5.5 0 0 1-.5.5H5v5H3.5V7h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5H5V5z"/></svg>
            </button>
            <button type="button" class="btn btn-sm" title="Cursiva" onclick="document.execCommand('italic', false, null)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M7.86 6.5h-1.35v-1.5H9V8H7.5v3H6V5H4.32v3H3V5h-1v6h1.5v-3h1.35v3H6V8h1.5v-1.5z"/></svg>
            </button>
            <button type="button" class="btn btn-sm" title="Subrayado" onclick="document.execCommand('underline', false, null)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M0 8V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2h-1V6a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2H0zm6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5z"/></svg>
            </button>
            </div>
            <div class="btn-group me-1">
            <button type="button" class="btn btn-sm" title="Lista viñetas" onclick="document.execCommand('insertUnorderedList', false, null)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm0-2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zm0 5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zm12-3H5v1h10V5.5zm0 3H5v1h10V8.5z"/></svg>
            </button>
            </div>
            <!-- Nuevo botón: Notas guardadas -->
            <div class="btn-group ms-auto">
            <button type="button" class="btn btn-sm btn-outline-primary" title="Notas guardadas" onclick="showSavedNotesLibrary()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 0A1.5 1.5 0 0 0 0 1.5V13a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V1.5A1.5 1.5 0 0 0 14.5 0h-13zM1 1.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V1.5z"/><path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/></svg>
                Notas guardadas
            </button>
            </div>
        </div>

        <!-- Editor principal -->
        <div
            id="alndinNotesEditor"
            contenteditable="true"
            class="form-control alndin-notes-editor border-top-0"
            style="min-height: 180px; max-height: 300px; overflow-y: auto; font-family: 'Inter', sans-serif; font-size: 1rem; line-height: 1.6;"
            placeholder="Escribe tus ideas aquí..."
        ></div>

        <!-- Indicador y acciones -->
        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted" id="notesStats">0 palabras | 0 caracteres</small>
            <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="alndinSaveCurrentNote()">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M8 2a1 1 0 0 1 1 1v1h1a1 1 0 1 1 0 2H9v1a1 1 0 1 1-2 0V6H6a1 1 0 1 1 0-2h1V3a1 1 0 0 1 1-1z"/></svg>
                Guardar nota
            </button>
            <button class="btn btn-sm btn-danger" onclick="alndinClearAllNotes()">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/></svg>
                Borrar todo
            </button>
            </div>
        </div>

        <!-- Vista de notas guardadas (oculta por defecto) -->
        <div id="savedNotesView" class="mt-4 d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Notas guardadas</h6>
            <button class="btn btn-sm" onclick="hideSavedNotesLibrary()">← Volver al editor</button>
            </div>
            <div id="savedNotesList" class="list-group">
            <!-- Las notas se cargarán aquí dinámicamente -->
            </div>
        </div>
        </div>

        <!-- Redes sociales -->
        <div class="tab-pane fade" id="social-tab-pane" role="tabpanel">
        <div class="d-grid gap-2">
            <a href="https://facebook.com" target="_blank" class="btn btn-sm btn-primary d-flex align-items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg> Facebook
            </a>
            <a href="https://instagram.com" target="_blank" class="btn btn-sm btn-danger d-flex align-items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.668.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/>
            </svg> Instagram
            </a>
            <a href="https://x.com" target="_blank" class="btn btn-sm btn-dark d-flex align-items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L3.001 22.996H.692l7.734-8.85L.184 2.25H8.04l4.957 6.576L18.244 2.25z"/>
            </svg> X (Twitter)
            </a>
            <a href="https://linkedin.com" target="_blank" class="btn btn-sm btn-info d-flex align-items-center gap-2 text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg> LinkedIn
            </a>
        </div>
        </div>
    </div>
    </div>

    <style>
    .alndin-trigger {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary-gradient);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    z-index: 1050;
    transition: transform 0.25s ease;
    }
    .alndin-trigger:hover {
    transform: scale(1.08);
    }
    .alndin-panel {
    position: fixed;
    bottom: 90px;
    right: 24px;
    width: 360px;
    background: var(--card-bg);
    color: var(--text-primary);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    z-index: 1040;
    padding: 20px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    }
    .dark-mode .alndin-panel {
    background: var(--card-dark);
    color: var(--text-light);
    }
    .alndin-notes-editor {
    min-height: 150px;
    resize: vertical;
    font-family: 'Inter', monospace;
    font-size: 0.95rem;
    line-height: 1.5;
    }
    .calc-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    }
    .calc-btn {
    height: 40px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s ease;
    }
    .dark-mode .calc-btn {
    background: var(--card-dark);
    color: var(--text-light);
    border-color: #334155;
    }
    .calc-btn:hover {
    background: #eef2ff;
    transform: translateY(-1px);
    }
    .dark-mode .calc-btn:hover {
    background: #334155;
    }
    .func, .clear {
    background: #f0f4ff;
    color: var(--igv-color);
    }
    .dark-mode .func, .dark-mode .clear {
    background: #2c2f4a;
    color: #7e9bff;
    }
    .operator {
    background: #eef2ff;
    color: var(--igv-color);
    }
    .dark-mode .operator {
    background: #2c2f4a;
    color: #7e9bff;
    }
    .equal {
    background: var(--igv-color);
    color: white;
    grid-row: span 2;
    }
    .equal:hover {
    background: #3a0ca3;
    }
    .nav-tabs .nav-link {
    font-weight: 600;
    color: var(--text-secondary);
    border: none;
    padding: 0.5rem 0.75rem;
    }
    .nav-tabs .nav-link.active {
    color: var(--igv-color);
    border-bottom: 2px solid var(--igv-color);
    }
    .dark-mode .nav-tabs .nav-link {
    color: var(--text-light-secondary);
    }
    .dark-mode .nav-tabs .nav-link.active {
    color: var(--igv-color);
    }

    /* Estilos adicionales para la librería de notas */
    .list-group-item {
    border: 1px solid var(--border-color);
    border-radius: 10px !important;
    margin-bottom: 8px;
    padding: 12px;
    background: var(--card-bg);
    color: var(--text-primary);
    }
    .dark-mode .list-group-item {
    background: var(--card-dark);
    color: var(--text-light);
    border-color: #334155;
    }
    .list-group-item h6 {
    margin-bottom: 6px;
    font-weight: 600;
    }
    .list-group-item p {
    margin-bottom: 8px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    }
    .list-group-item .btn-group-sm {
    display: flex;
    gap: 0.25rem;
    }
    </style>

    <script>
    // Panel toggle
    document.getElementById('alndinFloatingBtn').addEventListener('click', () => {
    document.getElementById('alndinPanel').classList.remove('d-none');
    });
    document.getElementById('closeAlndinPanel').addEventListener('click', () => {
    document.getElementById('alndinPanel').classList.add('d-none');
    });

    // === CALCULADORA AVANZADA ===
    function alndinCalcInput(val, needsComma = false) {
    const display = document.getElementById('alndinCalcDisplay');
    if (display.value === '0' && !['+', '-', '*', '/', '.', '(', ')'].includes(val)) {
        display.value = val;
    } else {
        if (needsComma && display.value !== '' && !display.value.endsWith('(')) {
        display.value += ',';
        }
        display.value += val;
    }
    }
    function alndinCalcEval() {
    const display = document.getElementById('alndinCalcDisplay');
    const history = document.getElementById('alndinCalcHistory');
    try {
        const expr = display.value
        .replace(/√/g, 'Math.sqrt')
        .replace(/π/g, 'Math.PI')
        .replace(/\^/g, '**');
        const result = Function('"use strict"; return (' + expr + ')')();
        const entry = `${display.value} = ${result}`;
        history.value = (history.value ? history.value + '\n' : '') + entry;
        display.value = String(result);
    } catch (e) {
        display.value = 'Error';
        setTimeout(() => display.value = '0', 1500);
    }
    }
    function alndinCalcClear() {
    document.getElementById('alndinCalcDisplay').value = '0';
    }
    function alndinCalcClearAll() {
    document.getElementById('alndinCalcDisplay').value = '0';
    document.getElementById('alndinCalcHistory').value = '';
    }

    // === SISTEMA DE NOTAS AVANZADO CON LIBRERÍA ===
    let currentNoteId = null;

    function alndinSaveCurrentNote() {
    const content = document.getElementById('alndinNotesEditor').innerHTML.trim();
    if (!content) return;
    
    const notesLibrary = JSON.parse(localStorage.getItem('alndinNotesLibrary') || '[]');

    if (currentNoteId !== null) {
        const note = notesLibrary.find(n => n.id === currentNoteId);
        if (note) {
        note.content = content;
        note.updatedAt = new Date().toISOString();
        note.title = generateNoteTitle(content);
        }
    } else {
        const newNote = {
        id: Date.now(),
        title: generateNoteTitle(content),
        content: content,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
        };
        notesLibrary.unshift(newNote);
    }

    localStorage.setItem('alndinNotesLibrary', JSON.stringify(notesLibrary));
    currentNoteId = null;
    updateNotesStats();
    }

    function generateNoteTitle(htmlContent) {
    const temp = document.createElement('div');
    temp.innerHTML = htmlContent;
    let text = temp.innerText.trim();
    if (text.length === 0) return 'Nota sin título';
    if (text.length > 30) return text.substring(0, 30) + '…';
    return text;
    }

    function alndinClearAllNotes() {
    document.getElementById('alndinNotesEditor').innerHTML = '';
    currentNoteId = null;
    updateNotesStats();
    }

    function updateNotesStats() {
    const editor = document.getElementById('alndinNotesEditor');
    const text = editor.innerText || '';
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    const chars = text.length;
    document.getElementById('notesStats').textContent = `${words} palabras | ${chars} caracteres`;
    }

    function showSavedNotesLibrary() {
    const editorView = document.querySelector('#notes-tab-pane > *:not(#savedNotesView)');
    if (editorView) {
        const elements = document.querySelectorAll('#notes-tab-pane > *:not(#savedNotesView)');
        elements.forEach(el => {
        if (el.style) el.style.display = 'none';
        });
    }
    document.getElementById('savedNotesView').classList.remove('d-none');
    loadSavedNotes();
    }

    function hideSavedNotesLibrary() {
    currentNoteId = null;
    document.getElementById('savedNotesView').classList.add('d-none');
    const elements = document.querySelectorAll('#notes-tab-pane > *:not(#savedNotesView)');
    elements.forEach(el => {
        if (el.style) el.style.display = '';
    });
    }

    function loadSavedNotes() {
    const notes = JSON.parse(localStorage.getItem('alndinNotesLibrary') || '[]');
    const list = document.getElementById('savedNotesList');
    if (notes.length === 0) {
        list.innerHTML = '<div class="text-center py-3 text-muted">No hay notas guardadas.</div>';
        return;
    }

    list.innerHTML = '';
    notes.forEach(note => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        const date = new Date(note.updatedAt).toLocaleDateString('es-PE', {
        hour: '2-digit',
        minute: '2-digit'
        });
        item.innerHTML = `
        <h6>${note.title}</h6>
        <p class="mb-2">${date}</p>
        <div class="btn-group-sm">
            <button class="btn btn-sm btn-outline-primary" onclick="editSavedNote(${note.id})">Editar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedNote(${note.id})">Eliminar</button>
        </div>
        `;
        list.appendChild(item);
    });
    }

    function editSavedNote(noteId) {
    const notes = JSON.parse(localStorage.getItem('alndinNotesLibrary') || '[]');
    const note = notes.find(n => n.id === noteId);
    if (note) {
        document.getElementById('alndinNotesEditor').innerHTML = note.content;
        currentNoteId = noteId;
        hideSavedNotesLibrary();
        updateNotesStats();
    }
    }

    function deleteSavedNote(noteId) {
    let notes = JSON.parse(localStorage.getItem('alndinNotesLibrary') || '[]');
    notes = notes.filter(n => n.id !== noteId);
    localStorage.setItem('alndinNotesLibrary', JSON.stringify(notes));
    loadSavedNotes();
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
    // Calculadora
    const display = document.getElementById('alndinCalcDisplay');
    const history = document.getElementById('alndinCalcHistory');
    
    // Notas
    const editor = document.getElementById('alndinNotesEditor');
    editor.addEventListener('input', updateNotesStats);
    
    // Cargar notas al cambiar a la pestaña
    document.getElementById('notes-tab').addEventListener('click', () => {
    const savedNotes = localStorage.getItem('alndinNotesLibrary');
    if (!savedNotes && currentNoteId === null) {
    editor.innerHTML = '';
    updateNotesStats();
    }

    function openCalendarPage() {
    window.open('alndin-calendar.html', '_blank', 'width=800,height=700,scrollbars=yes');
    }

    });
    });
    </script>
</body>
</html>

